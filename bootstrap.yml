- hosts: claudinha
  sudo: True
  vars_files:
    - vars/claudinha.yml
  environment:
    LC_ALL: en_GB.UTF-8

  pre_tasks:
  - name: Add group claudinha
    group:
      name: claudinha
      state: present

  - name: Add user remote
    user:
      name=remote
      password={{ vault_remote_password }}
      group=claudinha

  - name: Add SSH public key to user remote
    authorized_key:
      user=remote
      key="{{ lookup('file', "files/workstation.pub") }}"

  - name: Add remote user to sudoers
    lineinfile:
      dest=/etc/sudoers
      regexp='^remote ALL'
      line='remote ALL=(ALL) NOPASSWD:ALL'
      state=present

  - name: Disallow root SSH access
    lineinfile:
      dest=/etc/ssh/sshd_config
      regexp="^PermitRootLogin"
      line="PermitRootLogin no"
      state=present
    notify:
      - restart sshd

  - name: Run "apt-get update"
    apt:
      update_cache: yes
      cache_valid_time: 86400

  - name: Install "htop" package
    apt:
      name: htop
      state: present

  - name: Install "python3-pip" package
    apt:
      name: python3-pip
      state: present
      install_recommends: no

  - name: Install "python3-dev" package
    apt:
      name: python3-dev
      state: present
      install_recommends: no

  - name: Install "unicornhat" python package
    pip:
      name: unicornhat
      executable: pip3

  - name: Install "bitarray" python package
    pip:
      name: bitarray
      executable: pip3

  - name: Create project directory
    file:
      path: /opt/claudinha
      state: directory
      owner: pi
      group: claudinha
      mode: 0775

  - name: Synchronize directory
    synchronize:
      src: texto/
      dest: /opt/claudinha/
      group: no
      owner: no
      delete: yes
      recursive: yes
      rsync_opts:
        - "--no-motd"
        - "--exclude=.pyc,__pycavhe__,.cache"

  roles:
        - gunicorn
        - supervisor

  post_tasks:
  - name: Install "claudinha" python dependencies
    pip:
      requirements: /opt/claudinha/requirements.txt
      executable: pip3
    notify:
      - Restart Supervisor

  - name: Test claudinha app
    uri:
      url: http://127.0.0.1

  handlers:
  - name: restart sshd
    service:
      name=ssh
      state=restarted